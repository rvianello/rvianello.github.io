<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="-&gt;&lt;-">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>De lana caprina</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="https://rvianello.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href=".">

            <span id="blog-title">De lana caprina</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/" class="u-url">About the RDKit/Postgres Ordered Substructure Search Problem</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Riccardo Vianello
            </span></p>
            <p class="dateline">
            <a href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/" rel="bookmark">
            <time class="published dt-published" datetime="2021-12-29T11:55:06+01:00" itemprop="datePublished" title="2021-12-29 11:55">2021-12-29 11:55</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <img alt="another unrelated image of a festive cat" class="align-left" src="images/202112_t01.png"><p>Last summer Richard Apodaca wrote a <a class="reference external" href="https://depth-first.com/articles/2021/08/11/the-rdkit-postgres-ordered-substructure-search-problem/">blog post</a>
about using the RDKit PostgreSQL cartridge to support substructure search queries, which included a detailed discussion of how the performances of the
same query could significantly degrade when the substructure match constraint was combined with an "order by" clause, referencing another column from
the same table.</p>
<p>I couldn't find the time to actually read that post until much later, but during this break I finally found a moment to reproduce the reported
behavior, and also try to understand why it happens.</p>
<p>Very conveniently, the original blog post includes a complete description of how the test database was configured. Maybe any random subset of compounds from
ChEMBL could also work, but the instructions still saved me some time, and helped ensure that my setup was reasonably similar <a class="footnote-reference brackets" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#f0" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<p>The tests use a single table created with the statement below:</p>
<pre class="code sql"><a id="rest_code_50feb19046d94245891e10f6f78be785-1" name="rest_code_50feb19046d94245891e10f6f78be785-1"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">molecules</span> <span class="p">(</span><span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
<a id="rest_code_50feb19046d94245891e10f6f78be785-2" name="rest_code_50feb19046d94245891e10f6f78be785-2"></a>                        <span class="n">mol</span> <span class="n">mol</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<a id="rest_code_50feb19046d94245891e10f6f78be785-3" name="rest_code_50feb19046d94245891e10f6f78be785-3"></a>                        <span class="n">mw</span> <span class="nb">NUMERIC</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<a id="rest_code_50feb19046d94245891e10f6f78be785-4" name="rest_code_50feb19046d94245891e10f6f78be785-4"></a>                        <span class="n">fp</span> <span class="nb">bit</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<a id="rest_code_50feb19046d94245891e10f6f78be785-5" name="rest_code_50feb19046d94245891e10f6f78be785-5"></a>                    <span class="p">);</span>
</pre>
<p>and filled with the molecule and molecular weight computed by the RDKit cartridge on the first 100000 <a class="footnote-reference brackets" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#f1" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> records from the downloaded eMolecules dataset.
On this table, a gist index is created on the <cite>mol</cite> column, and a regular btree index is created on the <cite>mw</cite> column.</p>
<p>The reference test query consists in selecting the molecules matching a search for a benzene/phenyl substructure, and returning the first 25 hits:</p>
<pre class="code sql"><a id="rest_code_0e646efac46c4d97947fb489bba6094c-1" name="rest_code_0e646efac46c4d97947fb489bba6094c-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'c1ccccc1'</span> <span class="k">LIMIT</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-2" name="rest_code_0e646efac46c4d97947fb489bba6094c-2"></a><span class="o">+</span><span class="c1">---------------------------------------------------------+---------+</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-3" name="rest_code_0e646efac46c4d97947fb489bba6094c-3"></a><span class="o">|</span> <span class="n">mol</span>                                                     <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-4" name="rest_code_0e646efac46c4d97947fb489bba6094c-4"></a><span class="o">|</span><span class="c1">---------------------------------------------------------+---------|</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-5" name="rest_code_0e646efac46c4d97947fb489bba6094c-5"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="n">OCCCCl</span><span class="p">)</span><span class="n">cc1</span>                                       <span class="o">|</span> <span class="mi">184</span><span class="p">.</span><span class="mi">666</span> <span class="o">|</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-6" name="rest_code_0e646efac46c4d97947fb489bba6094c-6"></a><span class="o">|</span> <span class="n">O</span><span class="o">=</span><span class="k">C</span><span class="p">(</span><span class="n">CCc1ccccc1</span><span class="p">)</span><span class="n">c1ccc</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="n">cc1</span>                              <span class="o">|</span> <span class="mi">226</span><span class="p">.</span><span class="mi">275</span> <span class="o">|</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-7" name="rest_code_0e646efac46c4d97947fb489bba6094c-7"></a><span class="p">...</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-8" name="rest_code_0e646efac46c4d97947fb489bba6094c-8"></a><span class="o">+</span><span class="c1">---------------------------------------------------------+---------+</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-9" name="rest_code_0e646efac46c4d97947fb489bba6094c-9"></a><span class="k">SELECT</span> <span class="mi">25</span>
<a id="rest_code_0e646efac46c4d97947fb489bba6094c-10" name="rest_code_0e646efac46c4d97947fb489bba6094c-10"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">011</span><span class="n">s</span>
</pre>
<p>Searching for a very common substructure limits the ability for the gist index implementation to prune the search tree, and may therefore require the
query execution to scan a larger portion of the index to identify the matching rows in the table. But in this case, things are actually made easier by the
limit clause, because the index scan ends as soon as the first 25 matching records are found, which is likely to happen quite soon, exactly because phenyl
rings are so frequently present in many compounds.</p>
<p>On the other hand, when a more selective query is performed, the index scan may happen to return a very small number of rows, and the query is again
quite fast:</p>
<pre class="code sql"><a id="rest_code_04fdbef69c6d499d845761851d42f35a-1" name="rest_code_04fdbef69c6d499d845761851d42f35a-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'C(=S)Cl'</span> <span class="k">LIMIT</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-2" name="rest_code_04fdbef69c6d499d845761851d42f35a-2"></a><span class="o">+</span><span class="c1">---------------------+---------+</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-3" name="rest_code_04fdbef69c6d499d845761851d42f35a-3"></a><span class="o">|</span> <span class="n">mol</span>                 <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-4" name="rest_code_04fdbef69c6d499d845761851d42f35a-4"></a><span class="o">|</span><span class="c1">---------------------+---------|</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-5" name="rest_code_04fdbef69c6d499d845761851d42f35a-5"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="n">OC</span><span class="p">(</span><span class="o">=</span><span class="n">S</span><span class="p">)</span><span class="n">Cl</span><span class="p">)</span><span class="n">cc1</span> <span class="o">|</span> <span class="mi">186</span><span class="p">.</span><span class="mi">663</span> <span class="o">|</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-6" name="rest_code_04fdbef69c6d499d845761851d42f35a-6"></a><span class="o">+</span><span class="c1">---------------------+---------+</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-7" name="rest_code_04fdbef69c6d499d845761851d42f35a-7"></a><span class="k">SELECT</span> <span class="mi">1</span>
<a id="rest_code_04fdbef69c6d499d845761851d42f35a-8" name="rest_code_04fdbef69c6d499d845761851d42f35a-8"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">008</span><span class="n">s</span>
</pre>
<p>But, even if substructure queries that include a limit clause tend to be less challenging, some problems become anyway apparent if an ordering clause
is added:</p>
<pre class="code sql"><a id="rest_code_dca3dc38829b4f27987da720fe42cd91-1" name="rest_code_dca3dc38829b4f27987da720fe42cd91-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'c1ccccc1'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mw</span> <span class="k">limit</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-2" name="rest_code_dca3dc38829b4f27987da720fe42cd91-2"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-3" name="rest_code_dca3dc38829b4f27987da720fe42cd91-3"></a><span class="o">|</span> <span class="n">mol</span>                     <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-4" name="rest_code_dca3dc38829b4f27987da720fe42cd91-4"></a><span class="o">|</span><span class="c1">-------------------------+---------|</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-5" name="rest_code_dca3dc38829b4f27987da720fe42cd91-5"></a><span class="o">|</span> <span class="n">Cc1cccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">c1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-6" name="rest_code_dca3dc38829b4f27987da720fe42cd91-6"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">cc1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-7" name="rest_code_dca3dc38829b4f27987da720fe42cd91-7"></a><span class="p">...</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-8" name="rest_code_dca3dc38829b4f27987da720fe42cd91-8"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-9" name="rest_code_dca3dc38829b4f27987da720fe42cd91-9"></a><span class="k">SELECT</span> <span class="mi">25</span>
<a id="rest_code_dca3dc38829b4f27987da720fe42cd91-10" name="rest_code_dca3dc38829b4f27987da720fe42cd91-10"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">1</span><span class="p">.</span><span class="mi">963</span><span class="n">s</span>
</pre>
<p>Requiring the result records to be ordered by molecular weight made the same query almost 200x slower.</p>
<p>I think the problem is that with the available table and indices, the query planner is confronted with two main options. It could either use the index on
the <cite>mw</cite> column to scan the table in increasing molecular weight order, and explicitly check the query constraint <cite>mol@&gt;'c1ccccc1'</cite> to filter out the
undesired records one by one, or it could use the index on the <cite>mol</cite> column to select the matching records, and then sort these records by molecular weight.</p>
<p>Because the index on the <cite>mol</cite> column has the potential for reducing the number of evaluated records, this is the plan that normally applies, as confirmed by
looking at the output from <cite>EXPLAIN ANALYZE</cite>. The bottleneck, I think is not as much in whether the output records are efficiently sorted, but rather that for
a substructure query with a very poor selectivity (like <cite>c1ccccc1</cite>), the index scan is required to process a very large fraction of the search tree associated
to the <cite>mol</cite> column (in this specific case ~66K hits are initially selected from the index, about 2/3 of the overall data - a sequential scan of the
unindexed column would be probably faster).</p>
<p>More selective queries can still perform fine also when the query includes the <cite>order by</cite> query (the <cite>mol</cite> index search tree is efficiently pruned,
and a small number of records is selected), but searching for very common substructures can be very inefficient, and the limit clause in this case doesn't
make things easier, because it only applies after the results are ordered.</p>
<p>The suggested workaround of turning off the use of explicit sorting steps in the query planner can indeed help:</p>
<pre class="code sql"><a id="rest_code_946f20ac0021443b9c625e363b129c7e-1" name="rest_code_946f20ac0021443b9c625e363b129c7e-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">enable_sort</span><span class="o">=</span><span class="k">off</span><span class="p">;</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-2" name="rest_code_946f20ac0021443b9c625e363b129c7e-2"></a>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-3" name="rest_code_946f20ac0021443b9c625e363b129c7e-3"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'c1ccccc1'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mw</span> <span class="k">limit</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-4" name="rest_code_946f20ac0021443b9c625e363b129c7e-4"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-5" name="rest_code_946f20ac0021443b9c625e363b129c7e-5"></a><span class="o">|</span> <span class="n">mol</span>                     <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-6" name="rest_code_946f20ac0021443b9c625e363b129c7e-6"></a><span class="o">|</span><span class="c1">-------------------------+---------|</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-7" name="rest_code_946f20ac0021443b9c625e363b129c7e-7"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">cc1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-8" name="rest_code_946f20ac0021443b9c625e363b129c7e-8"></a><span class="o">|</span> <span class="n">Cc1cccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">c1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-9" name="rest_code_946f20ac0021443b9c625e363b129c7e-9"></a><span class="p">...</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-10" name="rest_code_946f20ac0021443b9c625e363b129c7e-10"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-11" name="rest_code_946f20ac0021443b9c625e363b129c7e-11"></a><span class="k">SELECT</span> <span class="mi">25</span>
<a id="rest_code_946f20ac0021443b9c625e363b129c7e-12" name="rest_code_946f20ac0021443b9c625e363b129c7e-12"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">014</span><span class="n">s</span>
</pre>
<p>but I am afraid it could be just because in practice it prevents the planner from using the index on the <cite>mol</cite> column, and not using this index may impact
negatively other queries that would normally show a high selectivity:</p>
<pre class="code sql"><a id="rest_code_204383324f8040dab27a9f666293b399-1" name="rest_code_204383324f8040dab27a9f666293b399-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'C(=S)Cl'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mw</span> <span class="k">limit</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-2" name="rest_code_204383324f8040dab27a9f666293b399-2"></a><span class="o">+</span><span class="c1">---------------------+---------+</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-3" name="rest_code_204383324f8040dab27a9f666293b399-3"></a><span class="o">|</span> <span class="n">mol</span>                 <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-4" name="rest_code_204383324f8040dab27a9f666293b399-4"></a><span class="o">|</span><span class="c1">---------------------+---------|</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-5" name="rest_code_204383324f8040dab27a9f666293b399-5"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="n">OC</span><span class="p">(</span><span class="o">=</span><span class="n">S</span><span class="p">)</span><span class="n">Cl</span><span class="p">)</span><span class="n">cc1</span> <span class="o">|</span> <span class="mi">186</span><span class="p">.</span><span class="mi">663</span> <span class="o">|</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-6" name="rest_code_204383324f8040dab27a9f666293b399-6"></a><span class="o">+</span><span class="c1">---------------------+---------+</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-7" name="rest_code_204383324f8040dab27a9f666293b399-7"></a><span class="k">SELECT</span> <span class="mi">1</span>
<a id="rest_code_204383324f8040dab27a9f666293b399-8" name="rest_code_204383324f8040dab27a9f666293b399-8"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">2</span><span class="p">.</span><span class="mi">652</span><span class="n">s</span>
</pre>
<p>My impression is that one main limitation might be in the RDKit cartridge implementation, and more specifically in the selectivity estimation function
associated to the substructure operator <cite>@&gt;</cite>. If this function could return a better estimate of the selectivity associated to the given substructure query,
the query planner could make a better decision about whether to use the index and how (maybe an interesting project for the next year?).</p>
<p>In the meantime, I think a two-column index <a class="footnote-reference brackets" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#f2" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> could actually help the query planner leverage the information from both the <cite>mw</cite> and <cite>mol</cite> columns
at once.</p>
<p>The PostgreSQL gist index implementation provides support for multi-column indices, but a suitable "operator class" is required to be available for the
indexed data types. The RDKit cartridge provides this operator class for the molecule, fingerprint and reaction data types it implements, and similarly,
the <cite>btree_gist</cite> <a class="footnote-reference brackets" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#f3" id="footnote-reference-4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> extension provides gist operator classes for most numerical types that are available for PostgreSQL.</p>
<pre class="code sql"><a id="rest_code_91a5e21d3f1e4385a263479ac39ab380-1" name="rest_code_91a5e21d3f1e4385a263479ac39ab380-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">btree_gist</span><span class="p">;</span>
</pre>
<p>However, in order to leverage the gist index in supporting the <cite>ORDER BY</cite> query, we need to change the data type to use one whose operator class defines
the distance operator and function that are required for nearest neighbor queries. This operator (<cite>&lt;-&gt;</cite>) is not implemented for the <cite>NUMERIC</cite> data type <a class="footnote-reference brackets" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#f4" id="footnote-reference-5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>,
but it's available for the other numerical primitive types, including the floating point ones:</p>
<pre class="code sql"><a id="rest_code_78d4fe00ff5b4733ab0963435b0a09a6-1" name="rest_code_78d4fe00ff5b4733ab0963435b0a09a6-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">molecules</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">mw</span> <span class="k">TYPE</span> <span class="nb">real</span><span class="p">;</span>
</pre>
<p>This way, we can then create a combined gist index on both the <cite>mol</cite> and <cite>mw</cite> columns:</p>
<pre class="code sql"><a id="rest_code_99df60601e8a470294fb4f404fbcbbfb-1" name="rest_code_99df60601e8a470294fb4f404fbcbbfb-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">molecules_mol_mw</span> <span class="k">on</span> <span class="n">molecules</span> <span class="k">USING</span> <span class="n">gist</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">mw</span><span class="p">);</span>
</pre>
<p>And finally, a small change needs to apply to the executed query, in order to use the new index in the <cite>ORDER BY</cite> clause:</p>
<pre class="code sql"><a id="rest_code_394aa9f0232343eab97235ec269ad413-1" name="rest_code_394aa9f0232343eab97235ec269ad413-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'c1ccccc1'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mw</span> <span class="o">&lt;-&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span> <span class="k">limit</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-2" name="rest_code_394aa9f0232343eab97235ec269ad413-2"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-3" name="rest_code_394aa9f0232343eab97235ec269ad413-3"></a><span class="o">|</span> <span class="n">mol</span>                     <span class="o">|</span> <span class="n">mw</span>      <span class="o">|</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-4" name="rest_code_394aa9f0232343eab97235ec269ad413-4"></a><span class="o">|</span><span class="c1">-------------------------+---------|</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-5" name="rest_code_394aa9f0232343eab97235ec269ad413-5"></a><span class="o">|</span> <span class="n">Cc1cccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">c1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-6" name="rest_code_394aa9f0232343eab97235ec269ad413-6"></a><span class="o">|</span> <span class="n">Cc1ccc</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">cc1</span>            <span class="o">|</span> <span class="mi">106</span><span class="p">.</span><span class="mi">168</span> <span class="o">|</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-7" name="rest_code_394aa9f0232343eab97235ec269ad413-7"></a><span class="p">...</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-8" name="rest_code_394aa9f0232343eab97235ec269ad413-8"></a><span class="o">+</span><span class="c1">-------------------------+---------+</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-9" name="rest_code_394aa9f0232343eab97235ec269ad413-9"></a><span class="k">SELECT</span> <span class="mi">25</span>
<a id="rest_code_394aa9f0232343eab97235ec269ad413-10" name="rest_code_394aa9f0232343eab97235ec269ad413-10"></a><span class="k">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">013</span><span class="n">s</span>
</pre>
<p>The output from <cite>EXPLAIN ANALYZE</cite> may help confirm that the two-column index is actually used:</p>
<pre class="code sql"><a id="rest_code_11023ca685e843ff9256d85e4a994132-1" name="rest_code_11023ca685e843ff9256d85e4a994132-1"></a><span class="n">ric</span><span class="o">@/</span><span class="n">tmp</span><span class="p">:</span><span class="n">emolecules</span><span class="o">&gt;</span> <span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">SELECT</span> <span class="n">mol</span><span class="p">,</span> <span class="n">mw</span> <span class="k">FROM</span> <span class="n">molecules</span> <span class="k">WHERE</span> <span class="n">mol</span><span class="o">@&gt;</span><span class="s1">'c1ccccc1'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">mw</span> <span class="o">&lt;-&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span> <span class="k">limit</span> <span class="mi">25</span><span class="p">;</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-2" name="rest_code_11023ca685e843ff9256d85e4a994132-2"></a><span class="o">+</span><span class="c1">-----------------------------------------------------------------------------------------------------------------------------------------+</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-3" name="rest_code_11023ca685e843ff9256d85e4a994132-3"></a><span class="o">|</span> <span class="n">QUERY</span> <span class="n">PLAN</span>                                                                                                                              <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-4" name="rest_code_11023ca685e843ff9256d85e4a994132-4"></a><span class="o">|</span><span class="c1">-----------------------------------------------------------------------------------------------------------------------------------------|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-5" name="rest_code_11023ca685e843ff9256d85e4a994132-5"></a><span class="o">|</span> <span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">..</span><span class="mi">106</span><span class="p">.</span><span class="mi">84</span> <span class="k">rows</span><span class="o">=</span><span class="mi">25</span> <span class="n">width</span><span class="o">=</span><span class="mi">409</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="k">time</span><span class="o">=</span><span class="mi">2</span><span class="p">.</span><span class="mi">399</span><span class="p">..</span><span class="mi">4</span><span class="p">.</span><span class="mi">066</span> <span class="k">rows</span><span class="o">=</span><span class="mi">25</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                                                 <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-6" name="rest_code_11023ca685e843ff9256d85e4a994132-6"></a><span class="o">|</span>   <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">molecules_mol_mw</span> <span class="k">on</span> <span class="n">molecules</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="p">..</span><span class="mi">426</span><span class="p">.</span><span class="mi">53</span> <span class="k">rows</span><span class="o">=</span><span class="mi">100</span> <span class="n">width</span><span class="o">=</span><span class="mi">409</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="k">time</span><span class="o">=</span><span class="mi">2</span><span class="p">.</span><span class="mi">396</span><span class="p">..</span><span class="mi">4</span><span class="p">.</span><span class="mi">057</span> <span class="k">rows</span><span class="o">=</span><span class="mi">25</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-7" name="rest_code_11023ca685e843ff9256d85e4a994132-7"></a><span class="o">|</span>         <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">mol</span> <span class="o">@&gt;</span> <span class="s1">'c1ccccc1'</span><span class="p">::</span><span class="n">mol</span><span class="p">)</span>                                                                                            <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-8" name="rest_code_11023ca685e843ff9256d85e4a994132-8"></a><span class="o">|</span>         <span class="k">Order</span> <span class="k">By</span><span class="p">:</span> <span class="p">(</span><span class="n">mw</span> <span class="o">&lt;-&gt;</span> <span class="s1">'0'</span><span class="p">::</span><span class="nb">real</span><span class="p">)</span>                                                                                                    <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-9" name="rest_code_11023ca685e843ff9256d85e4a994132-9"></a><span class="o">|</span> <span class="n">Planning</span> <span class="k">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">202</span> <span class="n">ms</span>                                                                                                                 <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-10" name="rest_code_11023ca685e843ff9256d85e4a994132-10"></a><span class="o">|</span> <span class="n">Execution</span> <span class="k">Time</span><span class="p">:</span> <span class="mi">4</span><span class="p">.</span><span class="mi">146</span> <span class="n">ms</span>                                                                                                                <span class="o">|</span>
<a id="rest_code_11023ca685e843ff9256d85e4a994132-11" name="rest_code_11023ca685e843ff9256d85e4a994132-11"></a><span class="o">+</span><span class="c1">-----------------------------------------------------------------------------------------------------------------------------------------+</span>
</pre>
<p class="rubric">Footnotes</p>
<aside class="footnote brackets" id="f0" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>I was required to use a more current version of the eMolecules data (version 2021-07-01 is no longer available for download, so I used version
2022-01-01), and I also used PostgreSQL 14.1 from conda-forge, with a custom build of the RDKit cartridge (based on the current RDKit release
2021.09.3). I believe the slightly different configuration didn't introduce any significant difference compared to the original post.</p>
</aside><aside class="footnote brackets" id="f1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>The size of this test database is indeed small, but because the executed queries are limited to only select a small number of hits, it's
already sufficient to detect when there are any issues with the generated query plan. Also because this observation was in agreement with the
findings in the original post, I haven't spent a big amount of time exploring the dependencies from the database size, but a quick test with a
dataset about 10x larger provided about the same results.</p>
</aside><aside class="footnote brackets" id="f2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>The option of using a two-column index based on <cite>btree_gist</cite> was also already considered in the original post, but for some reason it was
reported to be ineffective.</p>
</aside><aside class="footnote brackets" id="f3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#footnote-reference-4">4</a><span class="fn-bracket">]</span></span>
<p>The <cite>btree_gist</cite> extension is part of the PostgreSQL source code distribution and should be most often available with any installation.</p>
</aside><aside class="footnote brackets" id="f4" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/the-rdkitpostgres-ordered-substructure-search-problem-and-maybe-a-solution/#footnote-reference-5">5</a><span class="fn-bracket">]</span></span>
<p><cite>NUMERIC</cite> is an arbitrary precision decimal data type. It's recommended for storing monetary amounts and other quantities where exactness
is required. I'm not sure its use for storing the molecular weight was anyway intended.</p>
</aside>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/" class="u-url">Extending ChEMBL with ChemicaLite (and of course RDKit)</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Riccardo Vianello
            </span></p>
            <p class="dateline">
            <a href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/" rel="bookmark">
            <time class="published dt-published" datetime="2020-12-29T21:42:33+01:00" itemprop="datePublished" title="2020-12-29 21:42">2020-12-29 21:42</time></a>
            </p>
        </div>
    </header><div class="e-content entry-content">
    <p>This blog post collects some draft notes about how to use <a class="reference external" href="https://github.com/rvianello/chemicalite">ChemicaLite</a>
to integrate some chemistry logic directly into the SQLite version of the <a class="reference external" href="https://www.ebi.ac.uk/chembl/">ChEMBL</a> database <a class="footnote-reference brackets" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#f1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<aside class="admonition attention"><p class="admonition-title">Attention!</p>
<p>This post is now quite old, the overall workflow is still informative, but several details in the ChemicaLite API have changed. Please consider
referring to the similar <a class="reference external" href="https://github.com/rvianello/chemicalite/blob/master/examples/setup_chembl.sql">example</a> script that is part of
the source code distribution, and in general to the documentation that is also available from
<a class="reference external" href="https://chemicalite.readthedocs.io/en/latest/">Read the Docs</a>.</p>
</aside><img alt="an unrelated image of a festive cat" class="align-right" src="images/202012_t01.png"><pre class="code shell"><a id="rest_code_430b5e3f18a746579ab85f4430a5c4b1-1" name="rest_code_430b5e3f18a746579ab85f4430a5c4b1-1"></a>$ <span class="c1"># you can download the ChEMBL database from ftp://ftp.ebi.ac.uk/pub/databases/chembl/ChEMBLdb/latest/</span>
<a id="rest_code_430b5e3f18a746579ab85f4430a5c4b1-2" name="rest_code_430b5e3f18a746579ab85f4430a5c4b1-2"></a>$ tar xvf ./chembl_27_sqlite.tar.gz
</pre>
<p>At this time the easiest way (for linux and osx <a class="footnote-reference brackets" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#f2" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> users) to get ChemicaLite probably consists in installing the experimental
conda packages I uploaded to <a class="reference external" href="https://anaconda.org/ric/chemicalite">anaconda.org</a>, together with the RDKit package from
conda-forge.</p>
<pre class="code shell"><a id="rest_code_f5fa5c51d76f4cd2bc3219362f7154c7-1" name="rest_code_f5fa5c51d76f4cd2bc3219362f7154c7-1"></a>$ conda create -n chembl-chemicalite -c conda-forge -c ric/label/dev rdkit chemicalite
<a id="rest_code_f5fa5c51d76f4cd2bc3219362f7154c7-2" name="rest_code_f5fa5c51d76f4cd2bc3219362f7154c7-2"></a>$ . activate chembl-chemicalite
</pre>
<p>SQLite drivers exist for basically all programming languages and environments, but to keep things simple, I will just
use some SQL code interactively in the SQLite shell:</p>
<pre class="code text"><a id="rest_code_15cb0e55ce32478790c0622dc3f058bf-1" name="rest_code_15cb0e55ce32478790c0622dc3f058bf-1"></a>(chembl-chemicalite) $ sqlite3 ./chembl_27/chembl_27_sqlite/chembl_27.db
<a id="rest_code_15cb0e55ce32478790c0622dc3f058bf-2" name="rest_code_15cb0e55ce32478790c0622dc3f058bf-2"></a>SQLite version 3.34.0 2020-12-01 16:14:00
<a id="rest_code_15cb0e55ce32478790c0622dc3f058bf-3" name="rest_code_15cb0e55ce32478790c0622dc3f058bf-3"></a>Enter ".help" for usage hints.
<a id="rest_code_15cb0e55ce32478790c0622dc3f058bf-4" name="rest_code_15cb0e55ce32478790c0622dc3f058bf-4"></a>sqlite&gt;
</pre>
<p>First, the ChemicaLite extension needs to be loaded (because the extension is provided as a runtime loadable module, this
operation is required on every new connection to the database, otherwise SQLite will complain that functions and types implemented
in the extension are not known/available). Please note that loading extensions is automatically enabled in
the SQLite shell. If you use a different driver or API, you may need to explicitly
<a class="reference external" href="https://sqlite.org/loadext.html">enable this operation</a>.</p>
<pre class="code sql"><a id="rest_code_450e8f59a48b44f089be15d5fc453822-1" name="rest_code_450e8f59a48b44f089be15d5fc453822-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="k">load</span> <span class="n">chemicalite</span>
</pre>
<p>For reference (and to quickly smoke-test the loaded extension) one can briefly verify which versions of ChemicaLite and RDKit are
available:</p>
<pre class="code sql"><a id="rest_code_3ce93805d86f4d2aae25de0af7b3bedb-1" name="rest_code_3ce93805d86f4d2aae25de0af7b3bedb-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">chemicalite_version</span><span class="p">(),</span> <span class="n">rdkit_version</span><span class="p">();</span>
<a id="rest_code_3ce93805d86f4d2aae25de0af7b3bedb-2" name="rest_code_3ce93805d86f4d2aae25de0af7b3bedb-2"></a><span class="mi">2020</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">5</span><span class="o">|</span><span class="mi">2020</span><span class="p">.</span><span class="mi">09</span><span class="p">.</span><span class="mi">3</span>
</pre>
<p>Once the extension is loaded, bindings to the RDKit toolkit become available as SQL functions and it is for example
possible to compute molecular descriptors directly on the compounds in the ChEMBL tables. However, it is usually
convenient to permanently extend the database schema with a table of RDKit molecules:</p>
<pre class="code sql"><a id="rest_code_741673a40c704d488c57a49123d3bd1c-1" name="rest_code_741673a40c704d488c57a49123d3bd1c-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rdkit_molecules</span><span class="p">(</span><span class="n">id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">molregno</span> <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">mol</span> <span class="n">MOL</span><span class="p">);</span>
<a id="rest_code_741673a40c704d488c57a49123d3bd1c-2" name="rest_code_741673a40c704d488c57a49123d3bd1c-2"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">rdkit_molecules</span> <span class="p">(</span><span class="n">molregno</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">molregno</span><span class="p">,</span> <span class="n">mol</span><span class="p">(</span><span class="n">canonical_smiles</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">compound_structures</span><span class="p">;</span>
</pre>
<p>This way chemical constraints (e.g. substructure searches) can be easily integrated in queries applying to the ChEMBL data:</p>
<pre class="code sql"><a id="rest_code_cd8bb977782c43a883271891385d5b3b-1" name="rest_code_cd8bb977782c43a883271891385d5b3b-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">cs</span><span class="p">.</span><span class="n">molregno</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">canonical_smiles</span> <span class="k">FROM</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-2" name="rest_code_cd8bb977782c43a883271891385d5b3b-2"></a>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">compound_structures</span> <span class="k">AS</span> <span class="n">cs</span> <span class="k">JOIN</span> <span class="n">rdkit_molecules</span> <span class="k">AS</span> <span class="n">rm</span> <span class="k">USING</span><span class="p">(</span><span class="n">molregno</span><span class="p">)</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-3" name="rest_code_cd8bb977782c43a883271891385d5b3b-3"></a>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">WHERE</span> <span class="n">mol_is_substruct</span><span class="p">(</span><span class="n">rm</span><span class="p">.</span><span class="n">mol</span><span class="p">,</span> <span class="s1">'c1cccc2c1nncc2'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">5</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-4" name="rest_code_cd8bb977782c43a883271891385d5b3b-4"></a>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">;</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-5" name="rest_code_cd8bb977782c43a883271891385d5b3b-5"></a><span class="mi">9830</span><span class="o">|</span><span class="n">CC</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="n">Sc1ccc</span><span class="p">(</span><span class="n">CC2CCN</span><span class="p">(</span><span class="n">C3CCN</span><span class="p">(</span><span class="k">C</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c4cnnc5ccccc45</span><span class="p">)</span><span class="n">CC3</span><span class="p">)</span><span class="n">CC2</span><span class="p">)</span><span class="n">cc1</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-6" name="rest_code_cd8bb977782c43a883271891385d5b3b-6"></a><span class="mi">37351</span><span class="o">|</span><span class="n">Cc1cccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">Nc2ccc3nnccc3c2</span><span class="p">)</span><span class="n">c1</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-7" name="rest_code_cd8bb977782c43a883271891385d5b3b-7"></a><span class="mi">47898</span><span class="o">|</span><span class="n">COC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c1c</span><span class="p">(</span><span class="k">C</span><span class="p">(</span><span class="n">F</span><span class="p">)(</span><span class="n">F</span><span class="p">)</span><span class="n">F</span><span class="p">)[</span><span class="n">nH</span><span class="p">]</span><span class="n">c2c</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="n">cc3c</span><span class="p">(</span><span class="n">c12</span><span class="p">)[</span><span class="k">C</span><span class="o">@</span><span class="n">H</span><span class="p">](</span><span class="n">CCl</span><span class="p">)</span><span class="k">C</span><span class="p">(</span><span class="n">c1cc2cc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c4cc5c</span><span class="p">(</span><span class="n">OC</span><span class="p">)</span><span class="k">c</span><span class="p">(</span><span class="n">OC</span><span class="p">)</span><span class="k">c</span><span class="p">(</span><span class="n">OC</span><span class="p">)</span><span class="n">cc5nn4</span><span class="p">)</span><span class="n">ccc2</span><span class="p">[</span><span class="n">nH</span><span class="p">]</span><span class="mi">1</span><span class="p">)</span><span class="n">N3C</span><span class="o">=</span><span class="n">O</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-8" name="rest_code_cd8bb977782c43a883271891385d5b3b-8"></a><span class="mi">62519</span><span class="o">|</span><span class="n">N</span><span class="o">#</span><span class="n">Cc1nnc2ccccc2c1NCCC</span><span class="p">(</span><span class="n">c1ccccc1</span><span class="p">)</span><span class="n">c1ccccc1</span>
<a id="rest_code_cd8bb977782c43a883271891385d5b3b-9" name="rest_code_cd8bb977782c43a883271891385d5b3b-9"></a><span class="mi">109577</span><span class="o">|</span><span class="n">CNC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)[</span><span class="k">C</span><span class="o">@</span><span class="n">H</span><span class="p">](</span><span class="n">CC</span><span class="p">(</span><span class="k">C</span><span class="p">)</span><span class="k">C</span><span class="p">)</span><span class="k">C</span><span class="p">[</span><span class="k">C</span><span class="o">@</span><span class="n">H</span><span class="p">](</span><span class="n">O</span><span class="p">)[</span><span class="k">C</span><span class="o">@</span><span class="n">H</span><span class="p">](</span><span class="n">Cc1ccccc1</span><span class="p">)</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c1cnnc2ccccc12</span>
</pre>
<pre class="code sql"><a id="rest_code_a5191cab63f14cd69cef033bd2ac8acf-1" name="rest_code_a5191cab63f14cd69cef033bd2ac8acf-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">rdkit_molecules</span> <span class="k">WHERE</span> <span class="n">mol_is_substruct</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="s1">'c1cccc2c1nncc2'</span><span class="p">);</span>
<a id="rest_code_a5191cab63f14cd69cef033bd2ac8acf-2" name="rest_code_a5191cab63f14cd69cef033bd2ac8acf-2"></a><span class="mi">485</span>
</pre>
<p>The above queries are nice and simple, but without a proper (chemistry aware) index, the whole <code class="docutils literal">rdkit_molecules</code> table is
scanned sequentially, the substructure constraint is checked explicitly on every molecule, resulting in some poor performances.</p>
<p>Differently from other database engines, SQLite doesn't support creating a custom index directly on the <code class="docutils literal">mol</code> column.
Instead, SQLite supports a <a class="reference external" href="https://sqlite.org/vtab.html">virtual table</a> mechanism, which allows wrapping the index data
structure with a table-like interface. This way, an indexed search can be performed by joining the queried column with the
virtual table that implements the index.</p>
<p>ChemicaLite provides an <code class="docutils literal">rdtree</code> virtual table that implements an index structure for binary fingerprints. For
substructure queries, an index based on the <code class="docutils literal">rdtree</code> and the RDKit pattern fingerprint can be created with the following
two statements:</p>
<pre class="code sql"><a id="rest_code_5bd7ae61cb884946998d03d7f20514c2-1" name="rest_code_5bd7ae61cb884946998d03d7f20514c2-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="n">VIRTUAL</span> <span class="k">TABLE</span> <span class="n">rdkit_struct_index</span> <span class="k">USING</span> <span class="n">rdtree</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span> <span class="n">bits</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span> <span class="n">OPT_FOR_SUBSET_QUERIES</span><span class="p">);</span>
<a id="rest_code_5bd7ae61cb884946998d03d7f20514c2-2" name="rest_code_5bd7ae61cb884946998d03d7f20514c2-2"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">rdkit_struct_index</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">mol_bfp_signature</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">rdkit_molecules</span> <span class="k">WHERE</span> <span class="n">mol</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</pre>
<p>The example substructure queries above can be refactored to leverage this index table, which will allow them to run significantly
faster <a class="footnote-reference brackets" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#f3" id="footnote-reference-3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> :</p>
<pre class="code sql"><a id="rest_code_5705925ca5c14d3aac713bf58675c201-1" name="rest_code_5705925ca5c14d3aac713bf58675c201-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">WITH</span> <span class="n">matching</span> <span class="k">AS</span> <span class="p">(</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-2" name="rest_code_5705925ca5c14d3aac713bf58675c201-2"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="k">SELECT</span> <span class="n">rm</span><span class="p">.</span><span class="n">molregno</span><span class="p">,</span> <span class="n">rm</span><span class="p">.</span><span class="n">mol</span> <span class="k">FROM</span> <span class="n">rdkit_molecules</span> <span class="k">AS</span> <span class="n">rm</span> <span class="k">JOIN</span> <span class="n">rdkit_struct_index</span> <span class="k">AS</span> <span class="n">idx</span> <span class="k">USING</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-3" name="rest_code_5705925ca5c14d3aac713bf58675c201-3"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="k">WHERE</span> <span class="n">idx</span><span class="p">.</span><span class="n">id</span> <span class="k">MATCH</span> <span class="n">rdtree_subset</span><span class="p">(</span><span class="n">mol_bfp_signature</span><span class="p">(</span><span class="s1">'c1cccc2c1nncc2'</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-4" name="rest_code_5705925ca5c14d3aac713bf58675c201-4"></a><span class="p">...</span><span class="o">&gt;</span> <span class="p">)</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-5" name="rest_code_5705925ca5c14d3aac713bf58675c201-5"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">cs</span><span class="p">.</span><span class="n">molregno</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">canonical_smiles</span> <span class="k">FROM</span> <span class="n">compound_structures</span> <span class="k">AS</span> <span class="n">cs</span> <span class="k">JOIN</span> <span class="n">matching</span> <span class="k">AS</span> <span class="n">m</span> <span class="k">USING</span> <span class="p">(</span><span class="n">molregno</span><span class="p">)</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-6" name="rest_code_5705925ca5c14d3aac713bf58675c201-6"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">WHERE</span> <span class="n">mol_is_substruct</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">mol</span><span class="p">,</span> <span class="s1">'c1cccc2c1nncc2'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">5</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-7" name="rest_code_5705925ca5c14d3aac713bf58675c201-7"></a><span class="p">...</span><span class="o">&gt;</span> <span class="p">;</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-8" name="rest_code_5705925ca5c14d3aac713bf58675c201-8"></a><span class="mi">1216581</span><span class="o">|</span><span class="n">Cc1cnnc2ccccc12</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-9" name="rest_code_5705925ca5c14d3aac713bf58675c201-9"></a><span class="mi">1233534</span><span class="o">|</span><span class="n">O</span><span class="o">=</span><span class="k">C</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="n">c1cnnc2ccccc12</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-10" name="rest_code_5705925ca5c14d3aac713bf58675c201-10"></a><span class="mi">947201</span><span class="o">|</span><span class="n">Cc1cc2c</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="n">cccc2nn1</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-11" name="rest_code_5705925ca5c14d3aac713bf58675c201-11"></a><span class="mi">501513</span><span class="o">|</span><span class="n">Cc1cc2cc</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="k">c</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="n">cc2nn1</span>
<a id="rest_code_5705925ca5c14d3aac713bf58675c201-12" name="rest_code_5705925ca5c14d3aac713bf58675c201-12"></a><span class="mi">1295924</span><span class="o">|</span><span class="n">O</span><span class="o">=</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="p">]([</span><span class="n">O</span><span class="o">-</span><span class="p">])</span><span class="n">c1cccc2nnccc12</span>
</pre>
<pre class="code sql"><a id="rest_code_3a2ebe5adb3843658375c7c639776944-1" name="rest_code_3a2ebe5adb3843658375c7c639776944-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span>
<a id="rest_code_3a2ebe5adb3843658375c7c639776944-2" name="rest_code_3a2ebe5adb3843658375c7c639776944-2"></a><span class="p">...</span><span class="o">&gt;</span> <span class="n">rdkit_molecules</span> <span class="k">AS</span> <span class="n">rm</span> <span class="k">JOIN</span> <span class="n">rdkit_struct_index</span> <span class="k">AS</span> <span class="n">idx</span> <span class="k">USING</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<a id="rest_code_3a2ebe5adb3843658375c7c639776944-3" name="rest_code_3a2ebe5adb3843658375c7c639776944-3"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">WHERE</span> <span class="n">mol_is_substruct</span><span class="p">(</span><span class="n">rm</span><span class="p">.</span><span class="n">mol</span><span class="p">,</span> <span class="s1">'c1cccc2c1nncc2'</span><span class="p">)</span>
<a id="rest_code_3a2ebe5adb3843658375c7c639776944-4" name="rest_code_3a2ebe5adb3843658375c7c639776944-4"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">AND</span> <span class="n">idx</span><span class="p">.</span><span class="n">id</span> <span class="k">MATCH</span> <span class="n">rdtree_subset</span><span class="p">(</span><span class="n">mol_bfp_signature</span><span class="p">(</span><span class="s1">'c1cccc2c1nncc2'</span><span class="p">,</span> <span class="mi">2048</span><span class="p">));</span>
<a id="rest_code_3a2ebe5adb3843658375c7c639776944-5" name="rest_code_3a2ebe5adb3843658375c7c639776944-5"></a><span class="mi">485</span>
</pre>
<p>Very similarly, an index can be created to support similarity queries, in this case using Morgan binary fingerprints:</p>
<pre class="code sql"><a id="rest_code_ca2dfd1ec1324b9eb8c8bb9f45fb3f56-1" name="rest_code_ca2dfd1ec1324b9eb8c8bb9f45fb3f56-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="n">VIRTUAL</span> <span class="k">TABLE</span> <span class="n">rdkit_morgan_index</span> <span class="k">USING</span> <span class="n">rdtree</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span> <span class="n">bits</span><span class="p">(</span><span class="mi">2048</span><span class="p">),</span> <span class="n">OPT_FOR_SIMILARITY_QUERIES</span><span class="p">);</span>
<a id="rest_code_ca2dfd1ec1324b9eb8c8bb9f45fb3f56-2" name="rest_code_ca2dfd1ec1324b9eb8c8bb9f45fb3f56-2"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">rdkit_morgan_index</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">mol_morgan_bfp</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">rdkit_molecules</span> <span class="k">WHERE</span> <span class="n">mol</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</pre>
<pre class="code sql"><a id="rest_code_e151776e273c4b2f93e7b12773b276cf-1" name="rest_code_e151776e273c4b2f93e7b12773b276cf-1"></a><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">WITH</span> <span class="k">similar</span> <span class="k">AS</span> <span class="p">(</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-2" name="rest_code_e151776e273c4b2f93e7b12773b276cf-2"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="k">SELECT</span> <span class="n">rm</span><span class="p">.</span><span class="n">molregno</span><span class="p">,</span> <span class="n">idx</span><span class="p">.</span><span class="n">s</span> <span class="k">FROM</span> <span class="n">rdkit_molecules</span> <span class="k">AS</span> <span class="n">rm</span> <span class="k">JOIN</span> <span class="n">rdkit_morgan_index</span> <span class="k">AS</span> <span class="n">idx</span> <span class="k">USING</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-3" name="rest_code_e151776e273c4b2f93e7b12773b276cf-3"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="k">WHERE</span> <span class="n">idx</span><span class="p">.</span><span class="n">s</span> <span class="k">MATCH</span> <span class="n">rdtree_tanimoto</span><span class="p">(</span><span class="n">mol_morgan_bfp</span><span class="p">(</span><span class="s1">'Cc1ccc2nc(-c3ccc(NC(C4N(C(c5cccs5)=O)CCC4)=O)cc3)sc2c1'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span> <span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">)</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-4" name="rest_code_e151776e273c4b2f93e7b12773b276cf-4"></a><span class="p">...</span><span class="o">&gt;</span> <span class="p">)</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-5" name="rest_code_e151776e273c4b2f93e7b12773b276cf-5"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">SELECT</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-6" name="rest_code_e151776e273c4b2f93e7b12773b276cf-6"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="n">cs</span><span class="p">.</span><span class="n">molregno</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">canonical_smiles</span><span class="p">,</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-7" name="rest_code_e151776e273c4b2f93e7b12773b276cf-7"></a><span class="p">...</span><span class="o">&gt;</span>     <span class="n">bfp_tanimoto</span><span class="p">(</span><span class="n">mol_morgan_bfp</span><span class="p">(</span><span class="s1">'Cc1ccc2nc(-c3ccc(NC(C4N(C(c5cccs5)=O)CCC4)=O)cc3)sc2c1'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span> <span class="k">similar</span><span class="p">.</span><span class="n">s</span><span class="p">)</span> <span class="k">AS</span> <span class="n">similarity</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-8" name="rest_code_e151776e273c4b2f93e7b12773b276cf-8"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">FROM</span> <span class="n">compound_structures</span> <span class="k">AS</span> <span class="n">cs</span> <span class="k">JOIN</span> <span class="k">similar</span> <span class="k">USING</span> <span class="p">(</span><span class="n">molregno</span><span class="p">)</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-9" name="rest_code_e151776e273c4b2f93e7b12773b276cf-9"></a><span class="p">...</span><span class="o">&gt;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">similarity</span> <span class="k">DESC</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-10" name="rest_code_e151776e273c4b2f93e7b12773b276cf-10"></a><span class="p">...</span><span class="o">&gt;</span> <span class="p">;</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-11" name="rest_code_e151776e273c4b2f93e7b12773b276cf-11"></a><span class="mi">472512</span><span class="o">|</span><span class="n">Cc1ccc2nc</span><span class="p">(</span><span class="o">-</span><span class="n">c3ccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">C4CCN</span><span class="p">(</span><span class="k">C</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c5cccs5</span><span class="p">)</span><span class="n">CC4</span><span class="p">)</span><span class="n">cc3</span><span class="p">)</span><span class="n">sc2c1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">761194029850746</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-12" name="rest_code_e151776e273c4b2f93e7b12773b276cf-12"></a><span class="mi">471317</span><span class="o">|</span><span class="n">Cc1ccc2nc</span><span class="p">(</span><span class="o">-</span><span class="n">c3ccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">C4CCCN</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c5cccs5</span><span class="p">)</span><span class="n">C4</span><span class="p">)</span><span class="n">cc3</span><span class="p">)</span><span class="n">sc2c1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">64</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-13" name="rest_code_e151776e273c4b2f93e7b12773b276cf-13"></a><span class="mi">471461</span><span class="o">|</span><span class="n">Cc1ccc2nc</span><span class="p">(</span><span class="o">-</span><span class="n">c3ccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">C4CCN</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c5cccs5</span><span class="p">)</span><span class="n">CC4</span><span class="p">)</span><span class="n">cc3</span><span class="p">)</span><span class="n">sc2c1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">621621621621622</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-14" name="rest_code_e151776e273c4b2f93e7b12773b276cf-14"></a><span class="mi">1032469</span><span class="o">|</span><span class="n">O</span><span class="o">=</span><span class="k">C</span><span class="p">(</span><span class="n">Nc1nc2ccc</span><span class="p">(</span><span class="n">Cl</span><span class="p">)</span><span class="n">cc2s1</span><span class="p">)[</span><span class="k">C</span><span class="o">@@</span><span class="n">H</span><span class="p">]</span><span class="mi">1</span><span class="n">CCCN1C</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c1cccs1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">614285714285714</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-15" name="rest_code_e151776e273c4b2f93e7b12773b276cf-15"></a><span class="mi">471319</span><span class="o">|</span><span class="n">Cc1ccc2nc</span><span class="p">(</span><span class="o">-</span><span class="n">c3ccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">C4CCN</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c5cccs5</span><span class="p">)</span><span class="n">C4</span><span class="p">)</span><span class="n">cc3</span><span class="p">)</span><span class="n">sc2c1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">613333333333333</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-16" name="rest_code_e151776e273c4b2f93e7b12773b276cf-16"></a><span class="mi">751668</span><span class="o">|</span><span class="n">COc1ccc2nc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)[</span><span class="k">C</span><span class="o">@@</span><span class="n">H</span><span class="p">]</span><span class="mi">3</span><span class="n">CCCN3C</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c3cccs3</span><span class="p">)</span><span class="n">sc2c1</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">611111111111111</span>
<a id="rest_code_e151776e273c4b2f93e7b12773b276cf-17" name="rest_code_e151776e273c4b2f93e7b12773b276cf-17"></a><span class="mi">740754</span><span class="o">|</span><span class="n">Cc1ccc</span><span class="p">(</span><span class="n">NC</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">C2CCCN2C</span><span class="p">(</span><span class="o">=</span><span class="n">O</span><span class="p">)</span><span class="n">c2cccs2</span><span class="p">)</span><span class="n">cc1C</span><span class="o">|</span><span class="mi">0</span><span class="p">.</span><span class="mi">606060606060606</span>
</pre>
<p>I collected the modifying queries from this post into a small script (please note that the script doesn't include
any error handling or graceful recovery from any error conditions):</p>
<script src="https://gist.github.com/87a6173b033c9ea0ee206a9a7b9bd042.js"></script><noscript>
<pre class="literal-block">-- This script was tested with ChEMBL 27, ChemicaLite 2020.12.5, RDKit 2020.09.3
-- (it may not work with any later releases)

-- Load the ChemicaLite extension
.load chemicalite

-- Create a table of RDKit molecules
CREATE TABLE rdkit_molecules(id INTEGER PRIMARY KEY, molregno BIGINT NOT NULL, mol MOL);
INSERT INTO rdkit_molecules (molregno, mol) SELECT molregno, mol(canonical_smiles) FROM compound_structures;

-- Create an index for substructure queries
CREATE VIRTUAL TABLE rdkit_struct_index USING rdtree(id, s bits(2048), OPT_FOR_SUBSET_QUERIES);
INSERT INTO rdkit_struct_index (id, s) SELECT id, mol_bfp_signature(mol, 2048) FROM rdkit_molecules WHERE mol IS NOT NULL;

-- Create an index for similarity queries
CREATE VIRTUAL TABLE rdkit_morgan_index USING rdtree(id, s bits(2048), OPT_FOR_SIMILARITY_QUERIES);
INSERT INTO rdkit_morgan_index (id, s) SELECT id, mol_morgan_bfp(mol, 2, 2048) FROM rdkit_molecules WHERE mol IS NOT NULL;

-- Exit the SQLite shell
.quit

</pre>
</noscript>
<p>This script may take some time to execute (about 50' on my home laptop, more than a half of which apparently spent
computing and filling the SSS index). With the additional tables, the database file size (ignoring any storage temporarily used by SQLite
while applying the changes) grows by about 2 GB.</p>
<!-- rubric: Footnotes -->
<aside class="footnote brackets" id="f1" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p>The attentive reader will notice that this post is late by almost
<a class="reference external" href="http://chembl.blogspot.com/2016/03/chembl-db-on-sqlite-is-that-even.html">5 years</a>. But better
late than never :-)</p>
</aside><aside class="footnote brackets" id="f2" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#footnote-reference-2">2</a><span class="fn-bracket">]</span></span>
<p>These packages are built using the <a class="reference external" href="https://github.com/features/actions">GitHub Actions</a> infrastructure (thank you GitHub for
making it available). Please note that I am not an osx user, and the osx packages are only unit-tested as part of the build workflow.</p>
</aside><aside class="footnote brackets" id="f3" role="note"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="posts/extending-chembl-with-chemicalite-and-of-course-rdkit/#footnote-reference-3">3</a><span class="fn-bracket">]</span></span>
<p>You may notice that the <code class="docutils literal">compound_structures</code> records returned by the <cite>LIMIT 5</cite> clause do not match those from the earlier,
supposedly equivalent, example. This is because in this second query the ordering of the selected records is determined by the
traversal of the index tree. An additional <cite>ORDER BY molregno</cite> clause would have ensured consistent results.</p>
</aside>
</div>
    </article>
</div>



    





        <!--End of body content-->

        <footer id="footer">
            Contents © 2021         <a href="mailto:">Riccardo Vianello</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
